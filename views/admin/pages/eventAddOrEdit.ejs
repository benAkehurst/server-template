<!DOCTYPE html>
<html>

<head>
    <% include ../partials/head %>
</head>

<body>
    <div id="wrapper">
            <% include ../partials/menu %>

        <div id="page-wrapper" class="gray-bg">
            <div class="row border-bottom">
                <nav class="navbar navbar-static-top white-bg" role="navigation" style="margin-bottom: 0">
                    <div class="navbar-header">
                        <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#">
                            <i class="fa fa-bars"></i>
                        </a>

                    </div>
                </nav>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <div class="ibox float-e-margins">
                        <div class="ibox-title">
                            <div class="ibox-title-text-box">
                                <h5>Event</h5>
                                <% if(edit){ %>
                                    <a href="participants?eventId=<%= event._id %>" class="pull-right btn label-success">Manage Participants</a>
                                    <% } %>
                            </div>
                        </div>
                        <div class="ibox-content">
                            <div class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">Title</label>
                                    <div class="col-sm-6">
                                        <input id="title" type="text" name="" class="form-control" value="<%= edit ? event.title : '' %>">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">Sub Title</label>
                                    <div class="col-sm-6">
                                        <input id="subtitle" type="text" name="" class="form-control" value="<%= edit ? event.subTitle : '' %>">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">Category</label>
                                    <div class="col-sm-6">
                                        <input id="category" type="text" name="" class="form-control" value="<%= edit ? event.eventCategory : '' %>">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">Price Low</label>
                                    <div class="col-sm-2">
                                        <input id="price" type="text" class="form-control" value="<%= edit ? event.eventPrice : '' %>">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">Price High</label>
                                    <div class="col-sm-2">
                                        <input id="price2" type="text" class="form-control" value="<%= edit ? event.eventPrice2 : '' %>">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">Event Audience Type</label>
                                    <div class="col-sm-2">
                                        <label for="checkbox1">רכישה קבוצתית</label>
                                        <input id="checkbox1" type="radio" name="eventType" class="form-control" 
                                        <%=event.eventAudience=='רכישה קבוצתית'?"checked":""%> >
                                        
                                        <label for="checkbox2">אירועים משותפים</label>
                                        <input id="checkbox2" name="eventType" type="radio" class="form-control"
                                        <%=event.eventAudience=='אירועים משותפים'?"checked":""%> >
                                        <label for="checkbox3">אירועי קהילה</label>
                                        <input id="checkbox3" name="eventType" type="radio" class="form-control" 
                                        <%=event.eventAudience=='אירועי קהילה'?"checked":""%>>
                                    </div>
                                </div>
                                <div class="form-group">
                                        <label class="col-sm-2 control-label" for="eventHighPriority">Priority Event</label>
                                        <div class="col-sm-2">
                                            <input id="eventHighPriority" type="checkbox" name="eventHighPriority" class="form-control" 
                                            <%=event.eventHighPriority===true?"checked":""%> >
                                        </div>
                                    </div>
                                <% if(edit) { %>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">Tikets Sold</label>
                                        <div class="col-sm-2">
                                            <input id="ticket" type="number" min="0" class="form-control" value="<%= edit ? event.ticketsSold : '' %>">
                                        </div>
                                    </div>
                                    <% } %>
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Min participants</label>
                                            <div class="col-sm-2">
                                                <input id="minPar" type="number" min="0" class="form-control" value="<%= edit ? event.minimumPlacesNeeded : 0 %>">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Max participants</label>
                                            <div class="col-sm-2">
                                                <input id="maxPar" type="number" min="0" class="form-control" value="<%= edit ? event.maxiumumPlacesNeeded : 0 %>">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Last Date To Register</label>
                                            <div class="col-sm-2">
                                                <input id="RegisterUntil" type="date"  class="form-control" value="<%= edit ? event.lastRegistrationDate : '' %>">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Date</label>
                                            <div class="col-sm-2">
                                                <input id="date" type="date" min="0" class="form-control" value="<%= edit ? event.eventDate : '' %>">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Start time</label>
                                            <div class="col-sm-2">
                                                <input id="startTime" type="time" class="form-control" value="<%= edit ? event.eventTimeStart : '' %>">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">End time</label>
                                            <div class="col-sm-2">
                                                <input id="endTime" type="time" class="form-control" value="<%= edit ? event.eventTimeEnd : '' %>">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Event Duration</label>
                                            <div class="col-sm-2">
                                                <input id="duratuion" type="text" class="form-control" value="<%= edit ? event.eventDuration : '' %>">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Location</label>
                                            <div class="col-sm-6">
                                                <input id="location" type="text" name="" class="form-control" value="<%= edit ? event.eventLocation : '' %>">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">City</label>
                                            <div class="col-sm-6">
                                                <input id="city" type="text" name="" class="form-control" value="<%= edit ? event.eventCity : '' %>">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Cover Image</label>
                                            <div class="col-sm-2 ">
                                                <input id="img" type="file" accept="image/gif, image/jpeg, image/png" class="form-control">
                                            </div>
                                            <div class="col-sm-4 images-area">
                                                <% if(edit && event.eventImage != ''){ %>
                                                    <div class=" align-items-in-row ">
                                                        <img style="width: 150px;" src="<%= event.eventImage %>" />
                                                        <div class=" separate-obj-in-row">
                                                            <i class="fa fa-minus removeImage " aria-hidden="true"></i>
                                                        </div>
                                                    </div>
                                                    <% } %>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">File</label>
                                            <div class="col-sm-2 ">
                                                <input id="file" type="file" accept="image/gif, image/jpeg, image/png, application/pdf" class="form-control">
                                            </div>
                                            <div class="col-sm-4 file-area">
                                                <% if(edit && event.eventDownloadUrl != ''){ %>
                                                    <div class=" align-items-in-row ">
                                                        <a href="<%= event.eventDownloadUrl %>" download> Download File </a>
                                                        <div class=" separate-obj-in-row">
                                                            <i class="fa fa-minus removeFile " aria-hidden="true"></i>
                                                        </div>
                                                    </div>
                                                    <% } %>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">File Two</label>
                                            <div class="col-sm-2 ">
                                                <input id="fileTwo" type="file" accept="image/gif, image/jpeg, image/png, application/pdf" class="form-control">
                                            </div>
                                            <div class="col-sm-4 file-area">
                                                <% if(edit && event.eventSecondDownloadUrl != ''){ %>
                                                    <div class=" align-items-in-row ">
                                                        <a href="<%= event.eventSecondDownloadUrl %>" download> Download File </a>
                                                        <div class=" separate-obj-in-row">
                                                            <i class="fa fa-minus removeFile " aria-hidden="true"></i>
                                                        </div>
                                                    </div>
                                                    <% } %>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                                <label class="col-sm-2 control-label">Description</label>
                                                <div class="col-sm-6">
                                                    <div class="summernote" id="description"></div>
                                                </div>
                                            </div>
                                      

                                        <div class="hr-line-dashed"></div>
                                        <div class="form-group">
                                            <div class="col-sm-4 col-sm-offset-2">
                                                <a class="btn btn-white" href="events">Back</a>
                                                <input class="btn btn-primary" value="Save Changes" onclick="save()">
                                            </div>
                                        </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <div class="pull-right">
                <a href="http://moveosoftware.com">moveosoftware.com</a>
            </div>
            <div>
                <strong>Powered by</strong> Moveo Group
            </div>
        </div>
    </div>

    <script>
        var edit = <%= edit %>;
        var eventModel = <%- edit ? JSON.stringify(event) : false %>;
        var img = "<%= edit? event.eventImage: '' %>"
        var file = "<%= edit? event.eventDownloadUrl: '' %>";
        var fileTwo = "<%= edit? event.eventSecondDownloadUrl: '' %>";
        var today= new Date().toISOString().split("T")[0];
        // debugger;
        $("#RegisterUntil").attr('min' ,today );
        $("#date").attr('min' ,today );

        $( "#minPar" ).change(function() {
            // debugger;
            let val = $( "#minPar" ).val();
            $("#maxPar").attr('min' ,val );
            $("#maxPar").attr('value' ,Number(val) );
});
        



        function save() {
            var isValidated = validateData();
            if (isValidated[0]) {
                var objToSave = isValidated[1];
                if (edit) {
                    objToSave['_id'] = eventModel._id
                    var model = {
                        model: objToSave
                    };
                    $.ajax({
                        url: 'events',
                        type: 'put',
                        data: model,
                        success: function (response) {
                            if (response.success) {
                                window.location.href = '/admin/events';
                            }
                        }
                    });
                } else {
                    var model = {
                        model: objToSave
                    };
                    $.post('events', model, function (response) {
                        if (response.success) {
                            window.location.href = '/admin/events';
                        }
                    });
                }
            }
        };

        function validateData() {
            var title = $("#title").val()
            var subTitle = $("#subtitle").val()
            var category = $("#category").val()
            var price = $("#price").val()
            var price2 = $("#price2").val();
            var minPar = $("#minPar").val()
            var maxPar = $("#maxPar").val()
            var RegisterUntil = $("#RegisterUntil").val()
            var date = $("#date").val()
            var startTime = $("#startTime").val()
            var endTime = $("#endTime").val()
            var duration = $("#duratuion").val()
            var location = $("#location").val()
            var city = $("#city").val()
            var description = $("#description").code()
            var ticket = $("#ticket").val();
            var checkbox = '';
            if ($("#checkbox1").is(":checked")) {
                checkbox = 'רכישה קבוצתית';
            } else if ($("#checkbox2").is(":checked")) {
                checkbox = 'אירועים משותפים';
            } else if ($("#checkbox3").is(":checked")) {
                checkbox = 'אירועי קהילה';
            }
            var highPriority = '';
            if ($('#eventHighPriority').is(":checked")) {
                highPriority = true;
            }
            var correct = true;
            /*if (title == '' || subTitle == '' || category == '' || description == '' || city == '' || location == '' || price == '' || minPar == 0 || maxPar == 0 || startTime == '' || endTime == ''
                || duratuion == '' || date == '' || RegisterUntil == '') {
                showSwal('warning', 'Fill All Fields - first if');
                correct = false;
            } else */ 
            if (price > price2) {
                showSwal('warning','Minimum price larger than max price ')
                correct = false;
            } else if (minPar > maxPar)  {
                showSwal('warning','Minimum participents larger than max participents')
                correct = false;
            }
            /*else if( img == '' || file == '' || fileTwo == ''){
             showSwal('warning','Img or File not uploaded')
             correct=false;
            }*/
            else if (edit && ticket < 0) {
                showSwal('warning', 'Fill All Fields - edit & ticket');
                correct = false;
            }
            if (!correct) {
                return [false];
            }

            var timeRemaining = findTheDifferenceBetweenTwoDates(RegisterUntil, date);
            function findTheDifferenceBetweenTwoDates(firstDate, secondDate) {
                firstDate = new Date(firstDate);
                secondDate = new Date(secondDate);
                let timeDifference = Math.abs(secondDate.getTime() - firstDate.getTime());
                let millisecondsInADay = (1000 * 3600 * 24);
                let differenceOfDays = Math.ceil(timeDifference / millisecondsInADay);
                return differenceOfDays;
            }

            var model = {
                title: title,
                subTitle: subTitle,
                minimumPlacesNeeded: minPar,
                maxiumumPlacesNeeded: maxPar,
                lastRegistrationDate: RegisterUntil,
                eventAudience: checkbox,
                eventHighPriority: highPriority,
                eventDate: date,
                eventTimeStart: startTime,
                eventTimeEnd: endTime,
                eventDuration: duration,
                eventLocation: location,
                eventCity: city,
                eventPrice: price,
                eventPrice2: price2,
                eventCategory: category,
                eventDescription: description,
                eventImage: img,
                eventDownloadUrl: file,
                eventSecondDownloadUrl: fileTwo,
                timeRemaining: timeRemaining
            }
            if (edit) {
                model['ticketsSold'] = ticket
            }

            return [true, model]
        }















        //
        // ─── IMAGE SECTION ──────────────────────────────────────────────────────────────
        //  

        var region = "eu-west-1";
        var id = "7eab6e63-7f95-4b67-9546-f0e39c6931af";
        var version = '2006-03-01';
        var bucketName = "weshare-dev-images";
        var img = "<%= edit ? event.eventImage : '' %>";




        var S3Rapper = function (region, IdentityID, BucketName, apiVersion = '2006-03-01') {

            var _S3SdkWrapper = {};

            AWS.config.region = region;
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: region + ':' + IdentityID,
            });
            var s3 = new AWS.S3({
                apiVersion: apiVersion,
                params: { Bucket: BucketName }
            });

            //Method regions

            /*
            Params - img file , message for Info,Success,Error toast, and call back method
            Return -  Promise -object{
              success - type bool
              url - type string - if success then set the url
              error - type string - if not success then set the error
            }
            */
            _S3SdkWrapper.UploadImageAsync = function (file, cb) {

                var fileName = file.name;
                var fileType = fileName.substring(fileName.lastIndexOf('.') + 1, fileName.length)
                fileName = fileName.replace(fileType, '');
                var photoKey = fileName + Date.now() + '.' + fileType;
                s3.upload({
                    Key: photoKey,
                    Body: file,
                    ACL: 'public-read',
                    'Accept-Encoding': 'gzip',
                },
                    function (err, data) {
                        var resp;
                        if (err) {
                            resp = { success: false, error: err };

                        } else {
                            resp = { success: true, url: data.Location };
                        }
                        cb(resp);
                    }
                );
            }



            return _S3SdkWrapper;
        }


        $('#img').change(function (event) {
            $('.images-area').html('');
            s3Wrapp.UploadImageAsync(event.target.files[0], function (response) {
                if (response.success === true) {
                    img = response.url;
                    addImage(img)
                } else {
                    console.log(response);
                }
            }
            );
        });

        $('#file').change(function (event) {
            $('.file-area').html('');
            s3Wrapp.UploadImageAsync(event.target.files[0], function (response) {
                if (response.success === true) {
                    file = response.url;
                    addFile(file)
                } else {
                    console.log(response);
                }
            }
            );
        });

        var s3Wrapp = S3Rapper(region, id, bucketName, version);


        function removeFile() {
            $('.file-area').html('');
            file = '';
        }




        function addFile(fileUrl) {
            $('.file-area').append("<div class=\" align-items-in-row \">\
                        <a href=\""+ fileUrl + "\" download> Download File </a>\
                            <div class=\" separate-obj-in-row\">\
                                    <i  class=\"fa fa-minus removeFile \" aria-hidden=\"true\"></i>\
                            </div>\
                        </div>")
            $('.removeFile').click(removeFile);
        }


        function removeImage() {
            $('.images-area').html('');
            img = '';
        }

        function addImage(imgUrl) {
            $('.images-area').append("<div class=\" align-items-in-row \">\
                                <img style=\"width: 150px;\" src=\""+ imgUrl + " \" />\
                                <div class=\" separate-obj-in-row\">\
                                        <i  class=\"fa fa-minus removeImage \" aria-hidden=\"true\"></i>\
                                </div>\
                            </div>")
            $('.removeImage').click(removeImage);
        }



     function fillExistingData(){
         if(edit && eventModel.eventDescription)
                $('.summernote').code( eventModel.eventDescription);
            }

            $(document).ready(function(){
                $('.summernote').summernote();
                fillExistingData();
            });

    </script>
</body>

</html>